"use strict";(self.webpackChunk_2023pnm_seminar=self.webpackChunk_2023pnm_seminar||[]).push([[14],{7897:(e,t,i)=>{e.exports=i.p+"78a18ff1812c111c.bin"},719:(e,t,i)=>{e.exports=i.p+"631f8cfa3d6bae2a.bin"},9014:(e,t,i)=>{function n(e){return e`# Ptychography Helper Functions`}function a(e){return e.html`<hr class="hideable-md">`}function r(e){return e("https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.16/dist/numjs.min.js")}function l(e){return e("https://bundle.run/ndarray-ops@1.2.2")}function o(e){return e("https://bundle.run/ndarray-complex@1.0.3")}function s(e,t){return function(i,n){let a=e.zeros(i.shape);return t.atan2(a.selection,i.selection,n.selection),a}}function u(e,t){return function(i,n){let a=e.zeros(i.shape);return t.lts(a.selection,i.selection,n),t.bandseq(a.selection,1),a}}function c(e,t,i){return class n{constructor(t){this.shape=t;let i=t.slice();i.push(2),this.data=e.zeros(i),this._nulls=new Array(t.length).fill(null)}re(){return this.data.pick(...this._nulls,0)}im(){return this.data.pick(...this._nulls,1)}abs(){return e.sqrt(this.abs_sqr())}abs_sqr(){return e.add(this.re().multiply(this.re()),this.im().multiply(this.im()))}angle(){return t(this.im(),this.re())}clone(){let e=new n(this.shape);return e.data=this.data.clone(),e}conjugate(){let t=this.re().clone(),a=this.im().clone();i.conjeq(t.selection,a.selection);let r=new n(this.shape);return r.data=e.stack([t,a],-1),r}multiply(t){let a=this.re().clone(),r=this.im().clone(),l=t.re(),o=t.im();i.muleq(a.selection,r.selection,l.selection,o.selection);let s=new n(this.shape);return s.data=e.stack([a,r],-1),s}real_multiply(t){let a=this.re().clone(),r=this.im().clone(),l=t,o=e.zeros(t.shape);i.muleq(a.selection,r.selection,l.selection,o.selection);let s=new n(this.shape);return s.data=e.stack([a,r],-1),s}scalar_multiply(t,a){let r=this.re().clone(),l=this.im().clone();i.mulseq(r.selection,l.selection,t,a);let o=new n(this.shape);return o.data=e.stack([r,l],-1),o}add(t){let a=this.re().clone(),r=this.im().clone(),l=t.re(),o=t.im();i.addeq(a.selection,r.selection,l.selection,o.selection);let s=new n(this.shape);return s.data=e.stack([a,r],-1),s}subtract(t){let a=this.re().clone(),r=this.im().clone(),l=t.re(),o=t.im();i.subeq(a.selection,r.selection,l.selection,o.selection);let s=new n(this.shape);return s.data=e.stack([a,r],-1),s}}}function p(e){return function(t,i){let n=e.zeros(t),a=1/(t*i),r=1+((t-1)/2|0);for(var l=0;l<r;l++)n.set(l,l*a);for(l=r;l<t;l++)n.set(l,(l-t)*a);return n}}function d(e){return function(t,i){let n=[t.size,i.size],a=[];a[0]=e.zeros(n),a[1]=e.zeros(n);for(let e=0;e<n[1];e++)for(let r=0;r<n[0];r++)a[0].set(r,e,t.get(r)),a[1].set(r,e,i.get(e));return a}}function _(e){return function(t){let[i,n]=t.shape,a=i/2|0,r=n/2|0,l=e.zeros([i,n]);return l.slice([null,a],[null,r]).assign(t.slice(-a,-r),!1),l.slice([null,a],r).assign(t.slice(-a,[null,r]),!1),l.slice(-a,-r).assign(t.slice([null,a],[null,r]),!1),l.slice(-a,[null,r]).assign(t.slice([null,a],-r),!1),l}}function f(e,t,i,n){return function(a,r){let[l,o]=a.shape,[s,u]=r,c=new e([l,o]);c.data=t.fft(a.data);let p=i(l,1),d=i(o,1),[_,f]=n(p,d),b=-2*Math.PI,m=t.add(_.multiply(s),f.multiply(u)).multiply(b),h=new e([l,o]),v=t.cos(m),g=t.sin(m);h.data=t.stack([v,g],-1);let y=c.multiply(h);return y.data=t.ifft(y.data),y}}function b(e){return function(t,[i,n]){let a=new e([i,n]),r=i/2|0,l=n/2|0;return a.data.slice([null,r],[null,l],null).assign(t.slice([null,r],[null,l],null),!1),a.data.slice(-r,[null,l],null).assign(t.slice(-r,[null,l],null),!1),a.data.slice([null,r],-l,null).assign(t.slice([null,r],-l,null),!1),a.data.slice(-r,-l,null).assign(t.slice(-r,-l,null),!1),a}}function m(e,t,i){return function(n,a){let[r,l]=n.shape;console.log(r);let o=new e([r,l]);o.data=t.fft(n.data);let[s,u]=[r/a|0,l/a|0],c=i(o.data,[s,u]);return c.data=t.ifft(c.data),c}}function h(){return function(e){let t=9.109383*1e-30,i=1602177e-24,n=299792458;return 662607e-39/Math.sqrt(2*t*i*e)/Math.sqrt(1+i*e/2/t/n/n)*1e11}}function v(e){return function(t){let i=9.109383*1e-30,n=1602177e-24,a=299792458,r=e(t);return 2*Math.PI/r/t*(i*a*a+n*t)/(2*i*a*a+n*t)}}function g(e,t,i,n,a,r,l){return class{constructor(t,i,n,a,r){this._gpts=t.slice(),this._sampling=i.slice(),this._energy=n,this._wavelength=e(n),this._semiangle_cutoff=a,this._defocus=r}_get_scattering_angles(){let e=t(this._gpts[0],this._sampling[0]),r=t(this._gpts[1],this._sampling[1]),[l,o]=i(e,r);return[n.sqrt(n.add(l.multiply(l.multiply(this._wavelength*this._wavelength)),o.multiply(o.multiply(this._wavelength*this._wavelength)))),a(l,o)]}_evaluate_aberrations(e,t){let i=this._defocus/this._wavelength*Math.PI,a=e.multiply(e).multiply(i),l=n.cos(a),o=n.sin(a),s=new r(a.shape);return s.data=n.stack([l,o],-1),s}_evaluate_aperture(e,t){let i=this._semiangle_cutoff/1e3,a=new r(e.shape),o=l(e,i);return a.data=n.stack([o,n.zeros(e.shape)],-1),a}build(){let[e,t]=this._get_scattering_angles(),i=this._evaluate_aberrations(e,t),a=this._evaluate_aperture(e,t),l=i.multiply(a);this._fourier_array=l;let o=new r(l.shape);o.data=n.ifft(l.data);let s=Math.sqrt(o.abs_sqr().sum());return this._array=o.scalar_multiply(1/s,0),this}}}function y(e){return e`https://observablehq.com/@mootari/notebook-data`}function x(e,t){const i=e.module();return i.variable(t()).define(["md"],n),i.variable(t()).define(["htl"],a),i.variable(t("nj")).define("nj",["require"],r),i.variable(t("ops")).define("ops",["require"],l),i.variable(t("cops")).define("cops",["require"],o),i.variable(t("atan2")).define("atan2",["nj","ops"],s),i.variable(t("lt_int_s")).define("lt_int_s",["nj","ops"],u),i.variable(t("ComplexNDArray")).define("ComplexNDArray",["nj","atan2","cops"],c),i.variable(t("fftfreq")).define("fftfreq",["nj"],p),i.variable(t("meshgrid2D")).define("meshgrid2D",["nj"],d),i.variable(t("fftshift2D")).define("fftshift2D",["nj"],_),i.variable(t("fourier_shift")).define("fourier_shift",["ComplexNDArray","nj","fftfreq","meshgrid2D"],f),i.variable(t("corner_crop")).define("corner_crop",["ComplexNDArray"],b),i.variable(t("fourier_downsample")).define("fourier_downsample",["ComplexNDArray","nj","corner_crop"],m),i.variable(t("electron_wavelength_angstroms")).define("electron_wavelength_angstroms",h),i.variable(t("electron_interaction_parameter")).define("electron_interaction_parameter",["electron_wavelength_angstroms"],v),i.variable(t("ComplexProbe")).define("ComplexProbe",["electron_wavelength_angstroms","fftfreq","meshgrid2D","nj","atan2","ComplexNDArray","lt_int_s"],g),i.variable(t()).define(["md"],y),i}function w(e){return e`# Extended Ptychographic Iterative Engine

Here, we will use the extended ptychographic iterative engine (ePIE) to reconstruct the electrostatic potential of an fcc-like material made of 7 [111] atomic layers.`}function z(e){return e`First, hover over the probe intensity visualization to move the probe position around and see how the diffraction pattern below changes.`}function k(e,t,i,n,a,r,l){let o=[];return e.visualization_checkboxes.includes("probe")&&(o=[...o,t]),e.visualization_checkboxes.includes("diffraction")&&(o=[...o,i]),e.visualization_checkboxes.includes("gradient")&&(o=[...o,n]),e.visualization_checkboxes.includes("potential")&&(o=[...o,a]),r`<div style="display:flex; flex-wrap: wrap;">

${o.map((t=>l.legend({width:e.width,marginLeft:10,marginRight:10,label:t.label,color:{domain:t.domain,scheme:t.scheme,type:t.type,exponent:t.exponent,style:{background:"none"}}})))}`}function j(e,t,i,n,a,r,l,o,s,u,c){let p=10,d=[];e.visualization_checkboxes.includes("probe")&&(d=[...d,t]),e.visualization_checkboxes.includes("diffraction")&&(d=[...d,i]),e.visualization_checkboxes.includes("gradient")&&(d=[...d,n]),e.visualization_checkboxes.includes("potential")&&(d=[...d,a]);let _=d.length,f=e.width*_,b=e.width/r[0]*r[1];return l.plot({width:f,height:b-20,padding:0,margin:0,x:{axis:null,range:[0,f]},y:{axis:null,range:[0,b]},marks:[l.cell(o.cross(o.range(_),[0]).map((([e,t])=>({a:e,b:t}))),{x:"a",y:"b",render:(e,{x:t,y:i},{x:n,y:a,channels:{x:{value:r},y:{value:l}}})=>o.create("svg:g").call((l=>l.selectAll().data(e).join("g").attr("transform",(e=>`translate(${n[e]+p},${a[e]})`)).append((e=>s(d,r[e],t.bandwidth()-20,i.bandwidth()-20))))).on("pointerenter pointermove",(e=>u.value=c(o.pointer(e),[p,0],[t.bandwidth()-20,i.bandwidth()-20]))).node()})]})}function q(e){return e`## Gradient Descent Intuition

Toggling the "gradient" and "potential" checkboxes below will plot the phase update on the reconstructed potential in the current probe position.`}function C(e){return e.form({visualization_checkboxes:e.checkbox(["probe","diffraction","gradient","potential"],{value:["probe","diffraction"],label:"panels"}),options:e.checkbox(["reconstruct","random order"],{value:[],label:"ePIE"}),width:e.range([100,500],{value:220,step:1,label:"width"}),reset_potential_and_probe_position:e.button("reset potential and probe position")})}function A(e){return e`## Reactive Reconstruction
Toggle the "reconstruct" checkbox above to start a reactive reconstruction!`}function D(e){return e`This converges rather slowly when we scan in a raster. Toggling the "randomize" checkbox above will instead perform stochastic gradient descent.`}function M(e){return e.html`<hr class="hideable-md">`}async function P(e,t){let i=new Float32Array(await e("FCC-slab-dps-25x25x96x96-float32-shifted.npy").arrayBuffer()),n=Array.from(i),a=t.zeros([25,25,96,96]);return a.selection.data=n,t.sqrt(a)}async function I(e,t){let i=new Float32Array(await e("FCC-slab-dps-25x25x96x96-float32.npy").arrayBuffer()),n=Array.from(i),a=t.zeros([25,25,96,96]);return a.selection.data=n,t.sqrt(a)}function F(e,t,i){if(e.visualization_checkboxes.includes("diffraction")){let e=t.pick(i[1]/4,i[0]/4,null,null).pow(2);return{label:"Diffraction Intensity",scheme:"Magma",domain:[0,.003],type:"pow",exponent:.5,width:e.shape[1],height:e.shape[0],values:e.flatten().tolist()}}}function N(e){return e.shape.slice(2)}function R(e,t){return new e(t,[.255,.255],8e4,25,150).build()}function T(e,t,i,n){let a=e(t._array,[-i[1],-i[0]]).abs_sqr();return{label:"Illuminating Probe Intensity",scheme:"Greys",domain:[0,n],width:a.shape[1],height:a.shape[0],values:a.flatten().tolist()}}function E(e){return e._array.abs_sqr().max()}function G(e,t){let i=[];for(let n=0;n<e[0];n+=4)for(let t=0;t<e[1];t+=4)i=[...i,{x:n,y:t}];return t.rect(i,t.pointer({x1:"x",x2:e=>e.x+4,y1:"y",y2:e=>e.y+4,stroke:"none",fill:"none"}))}function L(e,t){return function(i,n){let a=n.clone(),r=new e(i.shape),l=t.cos(i),o=t.sin(i);return r.data=t.stack([l,o],-1),a=a.multiply(r),[a,r]}}function S(e,t){return function(i,n){let a=new e(n.shape);a.data=t.fft(n.data);let r=a.angle(),l=new e(n.shape),o=t.cos(r),s=t.sin(r);l.data=t.stack([o,s],-1),l=l.real_multiply(i);let u=l.subtract(a),c=new e(n.shape);return c.data=t.ifft(u.data),c}}function $(e,t){return e.zeros(t)}function B(e,t){return e.zeros(t)}function H(e){return{label:"Reconstructed Potential",scheme:"Magma",domain:[0,.75*e.max()+1e-4],width:e.shape[1],height:e.shape[0],values:e.flatten().tolist()}}function U(e,t){return function(i,n,a){let[r,l]=e(i,n);return[l,t(a,r)]}}function O(e,t,i,n,a,r){return function(l,[o,s],u){let c=o/4,p=(e[1]-s)%e[1]/4,d=t.pick(p,c,null,null),_=i(n._array,[-s,-o]),[f,b]=a(l,_,d),m=b.multiply(f.conjugate()).multiply(_.conjugate()).scalar_multiply(0,-1/r);return l.add(m.re().multiply(u))}}function W(e,t,i){return e(t,i,1)}function Z(e,t,i){if(e.visualization_checkboxes.includes("gradient")){let e=t.subtract(i);return{label:"Gradient Descent Step",scheme:"PuOr",domain:[e.min(),e.max()],width:e.shape[1],height:e.shape[0],values:e.flatten().tolist()}}}function J(e){return function(t){return e.clip(t,0)}}function K(e,t){if(e.options.includes("random order")){let e=t.randomInt(25);return[4*e(),4*e()]}return[0,0]}function Q(){return null}function V(e){return[e[0]/2,e[1]/2]}function X(e,t,i,n){let a=!1;return null!==e&&(e[0]==t[0]&&e[1]==i[1]-t[1]||(a=!0,n.value=[e[0],i[1]-e[1]])),a}function Y(e,t,i,n,a,r,l,o,s,u,c){if(e.options.includes("reconstruct")){if(e.options.includes("random order")){let e=t.randomInt(25),n=4*e(),a=4*e();i.value=[n,a]}else n[0]+4<100?i.value=[n[0]+4,n[1]]:n[1]+4<100?i.value=[0,n[1]+4]:i.value=[n[0]+4,0];e.visualization_checkboxes.includes("probe")&&(a.value=n);let u=r(l,n,1);o.value=s(u)}else u||(c.value=l.clone())}function ee(e,t,i,n,a,r,l,o,s,u){e&&t.visualization_checkboxes.includes("gradient")&&(i.value=n(a,r,1),t.visualization_checkboxes.includes("potential")&&(l.value=o(s),u.value=a.clone()))}function te(){return 0}function ie(e,t,i,n,a,r,l,o,s,u){e.reset_potential_and_probe_position!=t&&(i.value=null,n.value=a.zeros(r),l.value=a.zeros(r),o.value=[r[0]/2,r[1]/2],s.value=[0,0],u.value=e.reset_potential_and_probe_position)}function ne(e){return(t,i,n,a)=>e.plot({width:n,height:a,margin:0,x:{axis:null},y:{axis:null},color:{label:t[i].label,domain:t[i].domain,scheme:t[i].scheme,type:t[i].type,exponent:t[i].exponent,style:{background:"none"}},style:{background:"none"},marks:[e.raster(t[i].values,{width:t[i].width,height:t[i].height}),e.frame({strokeWidth:1})]})}function ae(e){return function([t,i],[n,a],[r,l]){let[o,s]=[(t-n)/r,(i-a)/l];return o>1?null:[4*Math.round(o*e[0]/4),4*Math.round(s*e[1]/4)]}}function re(e,t){const n=e.module();function a(){return this.url}const r=new Map([["FCC-slab-dps-25x25x96x96-float32.npy",{url:new URL(i(719),i.b),mimeType:"application/octet-stream",toString:a}],["FCC-slab-dps-25x25x96x96-float32-shifted.npy",{url:new URL(i(7897),i.b),mimeType:"application/octet-stream",toString:a}]]);n.builtin("FileAttachment",e.fileAttachments((e=>r.get(e)))),n.variable(t()).define(["md"],w),n.variable(t()).define(["md"],z),n.variable(t("visualization_legends")).define("visualization_legends",["viz_inputs","probe_dictionary","dp_dictionary","gradient_dictionary","potential_dictionary","html","Plot"],k),n.variable(t("main_visualization")).define("main_visualization",["viz_inputs","probe_dictionary","dp_dictionary","gradient_dictionary","potential_dictionary","gpts","Plot","d3","raster_subplot","mutable mouse_pos","left_panel_pixels_to_pos"],j),n.variable(t()).define(["md"],q),n.variable(t("viewof viz_inputs")).define("viewof viz_inputs",["Inputs"],C),n.variable(t("viz_inputs")).define("viz_inputs",["Generators","viewof viz_inputs"],((e,t)=>e.input(t))),n.variable(t()).define(["md"],A),n.variable(t()).define(["md"],D),n.variable(t()).define(["htl"],M);const l=e.module(x);return n.import("nj",l),n.import("ComplexNDArray",l),n.import("fftfreq",l),n.import("meshgrid2D",l),n.import("fourier_shift",l),n.import("fourier_downsample",l),n.import("ComplexProbe",l),n.variable(t("diffraction_amplitudes_shifted")).define("diffraction_amplitudes_shifted",["FileAttachment","nj"],P),n.variable(t("diffraction_amplitudes")).define("diffraction_amplitudes",["FileAttachment","nj"],I),n.variable(t("dp_dictionary")).define("dp_dictionary",["viz_inputs","diffraction_amplitudes_shifted","probe_xy"],F),n.variable(t("gpts")).define("gpts",["diffraction_amplitudes"],N),n.variable(t("real_space_probe")).define("real_space_probe",["ComplexProbe","gpts"],R),n.variable(t("probe_dictionary")).define("probe_dictionary",["fourier_shift","real_space_probe","probe_xy","probe_normalization"],T),n.variable(t("probe_normalization")).define("probe_normalization",["real_space_probe"],E),n.variable(t("mouseover_pointer")).define("mouseover_pointer",["gpts","Plot"],G),n.variable(t("overlap_projection")).define("overlap_projection",["ComplexNDArray","nj"],L),n.variable(t("fourier_projection")).define("fourier_projection",["ComplexNDArray","nj"],S),n.define("initial potential",["nj","gpts"],$),n.variable(t("mutable potential")).define("mutable potential",["Mutable","initial potential"],((e,t)=>new e(t))),n.variable(t("potential")).define("potential",["mutable potential"],(e=>e.generator)),n.define("initial potential_static",["nj","gpts"],B),n.variable(t("mutable potential_static")).define("mutable potential_static",["Mutable","initial potential_static"],((e,t)=>new e(t))),n.variable(t("potential_static")).define("potential_static",["mutable potential_static"],(e=>e.generator)),n.variable(t("potential_dictionary")).define("potential_dictionary",["potential"],H),n.variable(t("forward_operator")).define("forward_operator",["overlap_projection","fourier_projection"],U),n.variable(t("gradient_descent")).define("gradient_descent",["gpts","diffraction_amplitudes","fourier_shift","real_space_probe","forward_operator","probe_normalization"],O),n.define("initial gradient_step",["gradient_descent","potential_static","probe_xy"],W),n.variable(t("mutable gradient_step")).define("mutable gradient_step",["Mutable","initial gradient_step"],((e,t)=>new e(t))),n.variable(t("gradient_step")).define("gradient_step",["mutable gradient_step"],(e=>e.generator)),n.variable(t("gradient_dictionary")).define("gradient_dictionary",["viz_inputs","gradient_step","potential_static"],Z),n.variable(t("positivity_constraint")).define("positivity_constraint",["nj"],J),n.define("initial reconstruct_xy",["viz_inputs","d3"],K),n.variable(t("mutable reconstruct_xy")).define("mutable reconstruct_xy",["Mutable","initial reconstruct_xy"],((e,t)=>new e(t))),n.variable(t("reconstruct_xy")).define("reconstruct_xy",["mutable reconstruct_xy"],(e=>e.generator)),n.define("initial mouse_pos",Q),n.variable(t("mutable mouse_pos")).define("mutable mouse_pos",["Mutable","initial mouse_pos"],((e,t)=>new e(t))),n.variable(t("mouse_pos")).define("mouse_pos",["mutable mouse_pos"],(e=>e.generator)),n.define("initial probe_xy",["gpts"],V),n.variable(t("mutable probe_xy")).define("mutable probe_xy",["Mutable","initial probe_xy"],((e,t)=>new e(t))),n.variable(t("probe_xy")).define("probe_xy",["mutable probe_xy"],(e=>e.generator)),n.variable(t("probe_moving")).define("probe_moving",["mouse_pos","probe_xy","gpts","mutable probe_xy"],X),n.variable(t("reconstruct_mutable")).define("reconstruct_mutable",["viz_inputs","d3","mutable reconstruct_xy","reconstruct_xy","mutable probe_xy","gradient_descent","potential","mutable potential","positivity_constraint","probe_moving","mutable potential_static"],Y),n.variable(t("moving_mutable")).define("moving_mutable",["probe_moving","viz_inputs","mutable gradient_step","gradient_descent","potential_static","probe_xy","mutable potential_static","positivity_constraint","gradient_step","mutable potential"],ee),n.define("initial previous_potential_reset_value",te),n.variable(t("mutable previous_potential_reset_value")).define("mutable previous_potential_reset_value",["Mutable","initial previous_potential_reset_value"],((e,t)=>new e(t))),n.variable(t("previous_potential_reset_value")).define("previous_potential_reset_value",["mutable previous_potential_reset_value"],(e=>e.generator)),n.variable(t("reset_potential_mutable")).define("reset_potential_mutable",["viz_inputs","previous_potential_reset_value","mutable mouse_pos","mutable potential","nj","gpts","mutable potential_static","mutable probe_xy","mutable reconstruct_xy","mutable previous_potential_reset_value"],ie),n.variable(t("raster_subplot")).define("raster_subplot",["Plot"],ne),n.variable(t("left_panel_pixels_to_pos")).define("left_panel_pixels_to_pos",["gpts"],ae),n}function le(e){return e}function oe(e){return e}function se(e){return e}function ue(e){return e.html`<hr class="hideable-md">`}function ce(e){return e}function pe(e){return e}function de(e){return e}function _e(e,t){const i=e.module();i.variable(t()).define(["visualization_legends"],le),i.variable(t()).define(["main_visualization"],oe),i.variable(t()).define(["viewof viz_inputs"],se),i.variable(t()).define(["htl"],ue);const n=e.module(re);return i.import("visualization_legends",n),i.import("main_visualization",n),i.import("viewof viz_inputs",n),i.import("viz_inputs",n),i.import("reset_potential_mutable",n),i.import("reconstruct_mutable",n),i.import("moving_mutable",n),i.variable(t()).define(["reset_potential_mutable"],ce),i.variable(t()).define(["reconstruct_mutable"],pe),i.variable(t()).define(["moving_mutable"],de),i}i.d(t,{Z:()=>_e})}}]);